Bootstrap: docker
From: nvidia/cuda:11.7.0-runtime-ubuntu22.04
#From: nvidia/cuda:11.3.1-cudnn8-runtime-ubuntu18.04
Stage: spython-base

%files
%labels
maintainer  Edoardo Apra <edoardo.apra@pnnl.gov>
org.opencontainers.image.version  "1.0.0"
org.opencontainers.image.authors  "Edoardo Apra"
%post
CUDA=11.7
SINGULARITY_CUDA=11.7
CUDA_V1=11
CUDA_V2=7
# metainformation

apt-key del 7fa2af80
apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/3bf863cc.pub
#apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/7fa2af80.pub
#apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/3bf863cc.pub

apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y wget libstdc++6 cuda-minimal-build-${CUDA_V1}-${CUDA_V2}   && \
 rm -rf /var/lib/apt/lists/* && \
 apt-get autoremove -y && \
 apt-get clean


MYPREFIX="/opt/miniconda3"
wget --quiet -O /tmp/miniconda3.sh \
https://repo.anaconda.com/miniconda/Miniconda3-py38_23.3.1-0-Linux-x86_64.sh && \
 bash /tmp/miniconda3.sh -b -p ${MYPREFIX}  && \
 rm /tmp/miniconda3.sh
export CONDA_FETCH_THREADS=2 # parallel download for recent conda versions
export MAX_JOBS=2 # ninja workers
 eval "$(${MYPREFIX}/bin/conda shell.bash hook)"
#hack to fix miniconda GLIBCXX error
conda install libstdcxx-ng

find /opt/miniconda3 -name "libstdc++.so*"

strings /opt/miniconda3/lib/libstdc++.so.6 |grep GLIBCXX ||true
ls -l /opt/miniconda3/lib/libstdc++.so.6 /usr/lib/x86_64-linux-gnu/libstdc++.so.6 || true
rm -f /opt/miniconda3/lib/libstdc++.so.6*
cp /usr/lib/x86_64-linux-gnu/libstdc++.so.6 /opt/miniconda3/lib/libstdc++.so.6
strings /opt/miniconda3/lib/libstdc++.so.6 |grep GLIBCXX ||true
#cp -f /usr/lib/x86_64-linux-gnu/libstdc++.so.6 /opt/miniconda3/lib/python3.8/site-packages/openmm/../../../libstdc++.so.6 

  conda config --set  fetch_threads 2 || true
  conda install -q -y -c conda-forge  openmm 

python -m openmm.testInstallation

